from flask import Flask, request, render_template
import sqlite3

app = Flask(__name__)

def init_db():
    conn = sqlite3.connect('db/users.db')
    c = conn.cursor()
    with open('db/users.sql') as f:
        c.executescript(f.read())
    conn.commit()
    conn.close()

@app.route('/', methods=['GET', 'POST'])
def login():
    error = None
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        if username or password is None:
            return render_template('index.html', error = "Username/Password is missing!")
        conn = sqlite3.connect('db/users.db')
        c = conn.cursor()
        
        query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
        c.execute(query)

        user = c.fetchone()

        if user:
            return 'ctfgrf24{sql1nject10n_isPrettyCommon!_1ox93r}'
        else:
            error = 'Invalid credentials. Try again.'

        conn.close()

    return render_template('index.html', error=error)

if __name__ == '__main__':
    init_db()
    app.run(host='0.0.0.0', port=4090, debug=True)
