from flask import Flask, request, render_template
import os, subprocess

app = Flask(__name__)

@app.route('/', methods = ['GET', 'POST'])
def home():
    file_names = subprocess.Popen('ls -p | grep -v /', shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.readlines()
    fp = request.args.get('file')
    fp = fp if fp is not None else "Kembali Ke Pulau Berk 1.txt"
    if os.path.exists(fp) is False:
        return render_template('home.html', file = f'File:{fp} is not found!', file_names = [items for items in file_names if items != b'flag.txt\n' and items != b'app.py\n'])
    fd = os.open(fp, os.O_RDONLY)
    read = os.read(fd, 4080)
    return render_template('home.html', file = read.decode(), file_names = [items for items in file_names if items != b'flag.txt\n' and items != b'app.py\n'])

@app.errorhandler(Exception)
def handle_exception(e):
    if isinstance(e, PermissionError):
        return render_template('home.html', file = '<img src="https://media.tenor.com/Kxck-1-zgnYAAAAM/how-to-train-your-dragon-toothless.gif"><br>Bukan itu ya flag nya:)')

@app.errorhandler(500)
def status500(e):
    return render_template('home.html', file = 'Enter a valid name!'), 500

app.run(host='0.0.0.0', port=2003, debug=True)
